

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Generating rules using the CN2 algorithm &mdash; decision_rules 1.0.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../_static/nbsphinx-code-cells.css?v=2aa19091" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=8d563738"></script>
      <script src="../_static/doctools.js?v=9bcbadda"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
      <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
      <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Illustrative examples" href="../illustrative_example.html" />
    <link rel="prev" title="Generating rules with RuleKit" href="generating_with_rulekit.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            decision_rules
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../tutorials.html">Tutorials</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="manual_rules_classification.html">Define rules manually</a></li>
<li class="toctree-l2"><a class="reference internal" href="rules_regression.html">Evaluate regression rules</a></li>
<li class="toctree-l2"><a class="reference internal" href="generating_with_rulekit.html">Generate rules using RuleKit algorithm</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Generate rules using CN2 algorithm</a></li>
<li class="toctree-l2"><a class="reference internal" href="../illustrative_example.html">Illustrative examples</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../decision_rules.html">API Documentation</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">decision_rules</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../tutorials.html">Tutorials</a></li>
      <li class="breadcrumb-item active">Generating rules using the CN2 algorithm</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/tutorials/cn2.ipynb.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="Generating-rules-using-the-CN2-algorithm">
<h1>Generating rules using the CN2 algorithm<a class="headerlink" href="#Generating-rules-using-the-CN2-algorithm" title="Link to this heading"></a></h1>
<p>In this tutorial we will learn how to integrate decision rules with other rule induction packages. We will cover multiple topics such as: * creating decision-rules rulesets programiclly, * writing custom rule quality measures, * programmatic creation of decision rule sets.</p>
<p>We will use the implementation of the CN2 algorithm provided by the <a class="reference external" href="https://orange3.readthedocs.io/projects/orange-data-mining-library/en/latest/">Orange</a> package. In this tutorial we will use the popular <a class="reference external" href="https://www.kaggle.com/c/titanic/data">titanic</a> dataset. Later, we will write a custom rule set factory class that will transform an instance of the Orange rule set to an instance of the <code class="docutils literal notranslate"><span class="pre">decision_rules.classification.ClassificationRuleSet</span></code> class. At Finally, we will briefly introduce
the various operations that can be performed using such an object.</p>
<p>We will start by loading the <a class="reference external" href="https://www.kaggle.com/c/titanic/data">titanic</a> dataset. We will use the <code class="docutils literal notranslate"><span class="pre">submodule</span></code> of Orange data here.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[58]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">Orange.data</span> <span class="kn">import</span> <span class="n">Table</span>

<span class="n">titanic</span><span class="p">:</span> <span class="n">Table</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="s2">&quot;titanic&quot;</span><span class="p">)</span>

<span class="c1"># print some information about columns</span>
<span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="p">{</span>
            <span class="s2">&quot;Column type&quot;</span><span class="p">:</span> <span class="p">(</span>
                <span class="s2">&quot;label&quot;</span> <span class="k">if</span> <span class="n">index</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">titanic</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">attributes</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;feature&quot;</span>
            <span class="p">),</span>
            <span class="s2">&quot;Column name&quot;</span><span class="p">:</span> <span class="n">attr</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="s2">&quot;Data type&quot;</span><span class="p">:</span> <span class="s2">&quot;discrete&quot;</span> <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">is_discrete</span> <span class="k">else</span> <span class="s2">&quot;continuous&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Possible values&quot;</span><span class="p">:</span> <span class="n">attr</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">attr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
            <span class="nb">list</span><span class="p">(</span><span class="n">titanic</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">attributes</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="n">titanic</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">class_var</span><span class="p">]</span>
        <span class="p">)</span>
    <span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[58]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Column type</th>
      <th>Column name</th>
      <th>Data type</th>
      <th>Possible values</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>feature</td>
      <td>status</td>
      <td>discrete</td>
      <td>(crew, first, second, third)</td>
    </tr>
    <tr>
      <th>1</th>
      <td>feature</td>
      <td>age</td>
      <td>discrete</td>
      <td>(adult, child)</td>
    </tr>
    <tr>
      <th>2</th>
      <td>feature</td>
      <td>sex</td>
      <td>discrete</td>
      <td>(female, male)</td>
    </tr>
    <tr>
      <th>3</th>
      <td>label</td>
      <td>survived</td>
      <td>discrete</td>
      <td>(no, yes)</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>Note that Orange models do not operate on padnas data frames, as is the case with decision_rules, but use a custom representation of <code class="docutils literal notranslate"><span class="pre">Orange.data.Table</span></code>. It automatically encodes nominal columns using floats. We need to convert the data to a pandas data frame in order to use it with the decision_rules.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[53]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="n">X</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">titanic</span><span class="o">.</span><span class="n">X_df</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">titanic</span><span class="o">.</span><span class="n">Y_df</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span>

<span class="n">X</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[53]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>status</th>
      <th>age</th>
      <th>sex</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>_o8804</th>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>_o8805</th>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>_o8806</th>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>_o8807</th>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>_o8808</th>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>_o11000</th>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>_o11001</th>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>_o11002</th>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>_o11003</th>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>_o11004</th>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
  </tbody>
</table>
<p>2201 rows × 3 columns</p>
</div></div>
</div>
<p>Notice that now all functions are of type float, although they are still discrete.</p>
<p>Now we will continue to train the rule set using the CN2 algorithm. We will then print out the generated rules.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[59]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">Orange.classification.rules</span> <span class="kn">import</span> <span class="n">CN2Learner</span><span class="p">,</span> <span class="n">CN2Classifier</span>

<span class="c1"># train the ruleset using CN2 algorithm</span>
<span class="n">cn2_clasifier</span><span class="p">:</span> <span class="n">CN2Classifier</span> <span class="o">=</span> <span class="n">CN2Learner</span><span class="p">()(</span><span class="n">titanic</span><span class="p">)</span>

<span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">cn2_clasifier</span><span class="o">.</span><span class="n">rule_list</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">r</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
IF sex==female AND status==first AND age!=adult THEN survived=yes
IF sex==female AND status!=third AND age!=adult THEN survived=yes
IF sex!=female AND status==second AND age!=adult THEN survived=yes
IF sex==female AND status==first THEN survived=yes
IF status!=third AND age!=adult THEN survived=yes
IF sex!=female AND status==second THEN survived=no
IF status==crew AND sex!=male THEN survived=yes
IF status==second THEN survived=yes
IF sex!=female AND status==third AND age!=child THEN survived=no
IF status==crew THEN survived=no
IF sex!=female AND status!=first THEN survived=no
IF status==first THEN survived=no
IF age!=adult THEN survived=no
IF status==third THEN survived=no
IF TRUE THEN survived=no
</pre></div></div>
</div>
<p>To use our ruleset from decision-rules, we need to convert it to decision-rules ruleset. Here we are dealing with a classification problem, so we need a <code class="docutils literal notranslate"><span class="pre">decision_rules.classification.ClassificationRuleSet</span></code> object.</p>
<p>To convert CN2 classifiers into a <code class="docutils literal notranslate"><span class="pre">ClassificationRuleSet</span></code> object we will write a simple factory class.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[55]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">decision_rules.classification</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">ClassificationConclusion</span><span class="p">,</span>
    <span class="n">ClassificationRule</span><span class="p">,</span>
    <span class="n">ClassificationRuleSet</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">decision_rules.core.condition</span> <span class="kn">import</span> <span class="n">AbstractCondition</span>
<span class="kn">from</span> <span class="nn">decision_rules.conditions</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">CompoundCondition</span><span class="p">,</span>
    <span class="n">ElementaryCondition</span><span class="p">,</span>
    <span class="n">NominalCondition</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">Orange.classification.rules</span> <span class="kn">import</span> <span class="n">CN2Classifier</span>
<span class="kn">from</span> <span class="nn">Orange.classification.rules</span> <span class="kn">import</span> <span class="n">Rule</span> <span class="k">as</span> <span class="n">CN2Rule</span>
<span class="kn">from</span> <span class="nn">Orange.classification.rules</span> <span class="kn">import</span> <span class="n">Selector</span>


<span class="k">class</span> <span class="nc">OrangeCN2RuleSetFactory</span><span class="p">:</span>

    <span class="k">def</span> <span class="nf">make</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">CN2Classifier</span><span class="p">,</span> <span class="n">X_train</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ClassificationRuleSet</span><span class="p">:</span>
        <span class="n">ruleset</span><span class="p">:</span> <span class="n">ClassificationRuleSet</span> <span class="o">=</span> <span class="n">ClassificationRuleSet</span><span class="p">(</span>
            <span class="n">rules</span><span class="o">=</span><span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_make_rule</span><span class="p">(</span>
                    <span class="n">rule</span><span class="p">,</span>
                    <span class="n">column_names</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">X_train</span><span class="o">.</span><span class="n">columns</span><span class="p">),</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">rule_list</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="c1"># last rule is a default one</span>
        <span class="n">ruleset</span><span class="o">.</span><span class="n">default_conclusion</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_rule_conclusion</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">rule_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">ruleset</span>

    <span class="k">def</span> <span class="nf">_make_rule</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">cn2_rule</span><span class="p">:</span> <span class="n">CN2Rule</span><span class="p">,</span> <span class="n">column_names</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ClassificationRule</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ClassificationRule</span><span class="p">(</span>
            <span class="n">premise</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_make_rule_premise</span><span class="p">(</span><span class="n">cn2_rule</span><span class="p">),</span>
            <span class="n">conclusion</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_make_rule_conclusion</span><span class="p">(</span><span class="n">cn2_rule</span><span class="p">),</span>
            <span class="n">column_names</span><span class="o">=</span><span class="n">column_names</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_make_rule_premise</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cn2_rule</span><span class="p">:</span> <span class="n">CN2Rule</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CompoundCondition</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">CompoundCondition</span><span class="p">(</span>
            <span class="n">subconditions</span><span class="o">=</span><span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_make_subcondition</span><span class="p">(</span><span class="n">selector</span><span class="p">)</span> <span class="k">for</span> <span class="n">selector</span> <span class="ow">in</span> <span class="n">cn2_rule</span><span class="o">.</span><span class="n">selectors</span>
            <span class="p">]</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_make_subcondition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">selector</span><span class="p">:</span> <span class="n">Selector</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AbstractCondition</span><span class="p">:</span>
        <span class="c1"># tiny wrapping function to return negated version of given condition</span>
        <span class="k">def</span> <span class="nf">negated</span><span class="p">(</span><span class="n">condition</span><span class="p">:</span> <span class="n">AbstractCondition</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AbstractCondition</span><span class="p">:</span>
            <span class="n">condition</span><span class="o">.</span><span class="n">negated</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">condition</span><span class="o">.</span><span class="n">negated</span>
            <span class="k">return</span> <span class="n">condition</span>

        <span class="c1"># maps different selectors types for decision-rules conditions</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;==&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">c_index</span><span class="p">,</span> <span class="n">c_value</span><span class="p">:</span> <span class="n">NominalCondition</span><span class="p">(</span>
                <span class="n">column_index</span><span class="o">=</span><span class="n">c_index</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">c_value</span>
            <span class="p">),</span>
            <span class="s2">&quot;!=&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">c_index</span><span class="p">,</span> <span class="n">c_value</span><span class="p">:</span> <span class="n">negated</span><span class="p">(</span>
                <span class="n">NominalCondition</span><span class="p">(</span><span class="n">column_index</span><span class="o">=</span><span class="n">c_index</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">c_value</span><span class="p">)</span>
            <span class="p">),</span>
            <span class="s2">&quot;&lt;=&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">c_index</span><span class="p">,</span> <span class="n">c_value</span><span class="p">:</span> <span class="n">ElementaryCondition</span><span class="p">(</span>
                <span class="n">column_index</span><span class="o">=</span><span class="n">c_index</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">c_value</span><span class="p">),</span> <span class="n">right_closed</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">),</span>
            <span class="s2">&quot;&gt;=&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">c_index</span><span class="p">,</span> <span class="n">c_value</span><span class="p">:</span> <span class="n">ElementaryCondition</span><span class="p">(</span>
                <span class="n">column_index</span><span class="o">=</span><span class="n">c_index</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">c_value</span><span class="p">),</span> <span class="n">left_closed</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">),</span>
        <span class="p">}[</span><span class="n">selector</span><span class="o">.</span><span class="n">op</span><span class="p">](</span><span class="n">selector</span><span class="o">.</span><span class="n">column</span><span class="p">,</span> <span class="n">selector</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_make_rule_conclusion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cn2_rule</span><span class="p">:</span> <span class="n">CN2Rule</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ClassificationConclusion</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ClassificationConclusion</span><span class="p">(</span>
            <span class="n">column_name</span><span class="o">=</span><span class="n">cn2_rule</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">class_var</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">cn2_rule</span><span class="o">.</span><span class="n">prediction</span>
        <span class="p">)</span>
</pre></div>
</div>
</div>
<p>Now we will use our class with our ruleset.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[56]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ruleset</span><span class="p">:</span> <span class="n">ClassificationRuleSet</span> <span class="o">=</span> <span class="n">OrangeCN2RuleSetFactory</span><span class="p">()</span><span class="o">.</span><span class="n">make</span><span class="p">(</span><span class="n">cn2_clasifier</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span>

<span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="n">ruleset</span><span class="o">.</span><span class="n">rules</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">rule</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Default rule: &#39;</span><span class="p">,</span> <span class="n">ruleset</span><span class="o">.</span><span class="n">default_conclusion</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
IF sex = {0.0} AND status = {1.0} AND age != {0.0} THEN survived = 1
IF sex = {0.0} AND status != {3.0} AND age != {0.0} THEN survived = 1
IF sex != {0.0} AND status = {2.0} AND age != {0.0} THEN survived = 1
IF sex = {0.0} AND status = {1.0} THEN survived = 1
IF status != {3.0} AND age != {0.0} THEN survived = 1
IF sex != {0.0} AND status = {2.0} THEN survived = 0
IF status = {0.0} AND sex != {1.0} THEN survived = 1
IF status = {2.0} THEN survived = 1
IF sex != {0.0} AND status = {3.0} AND age != {1.0} THEN survived = 0
IF status = {0.0} THEN survived = 0
IF sex != {0.0} AND status != {1.0} THEN survived = 0
IF status = {1.0} THEN survived = 0
IF age != {0.0} THEN survived = 0
IF status = {3.0} THEN survived = 0
Default rule:  survived = 0
</pre></div></div>
</div>
<p>We can see that the rules are semantically identical, even though their textual representation is different.</p>
<p>Now we can check whether both models predict in the same way</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[57]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="c1"># original model predicitons (we need to transform class probabilities to class labels)</span>
<span class="n">cn2_pred</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">cn2_clasifier</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">titanic</span><span class="o">.</span><span class="n">X</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="c1"># decision-rules ruleset predictions</span>
<span class="n">ruleset_pred</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">ruleset</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

<span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">cn2_pred</span><span class="p">,</span> <span class="n">ruleset_pred</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
<span class="ansi-red-intense-fg ansi-bold">---------------------------------------------------------------------------</span>
<span class="ansi-red-intense-fg ansi-bold">InvalidStateError</span>                         Traceback (most recent call last)
Cell <span class="ansi-green-intense-fg ansi-bold">In[57], line 6</span>
<span class="ansi-green-fg">      4</span> cn2_pred: np<span style="color: rgb(98,98,98)">.</span>ndarray <span style="color: rgb(98,98,98)">=</span> np<span style="color: rgb(98,98,98)">.</span>argmax(cn2_clasifier<span style="color: rgb(98,98,98)">.</span>predict(titanic<span style="color: rgb(98,98,98)">.</span>X), axis<span style="color: rgb(98,98,98)">=</span><span style="color: rgb(98,98,98)">1</span>)
<span class="ansi-green-fg">      5</span> <span style="color: rgb(95,135,135)"># decision-rules ruleset predictions</span>
<span class="ansi-green-intense-fg ansi-bold">----&gt; 6</span> ruleset_pred: np<span style="color: rgb(98,98,98)">.</span>ndarray <span style="color: rgb(98,98,98)">=</span> <span class="ansi-yellow-bg">ruleset</span><span class="ansi-yellow-bg" style="color: rgb(98,98,98)">.</span><span class="ansi-yellow-bg">predict</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">X</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg">      8</span> np<span style="color: rgb(98,98,98)">.</span>array_equal(cn2_pred, ruleset_pred)

File <span class="ansi-green-intense-fg ansi-bold">c:\Users\cezar\OneDrive\Pulpit\EMAG\GIT\decision-rules\cn2\..\decision_rules\core\ruleset.py:340</span>, in <span class="ansi-cyan-fg">AbstractRuleSet.predict</span><span class="ansi-blue-intense-fg ansi-bold">(self, X)</span>
<span class="ansi-green-fg">    338</span> X: np<span style="color: rgb(98,98,98)">.</span>ndarray <span style="color: rgb(98,98,98)">=</span> <span style="color: rgb(0,135,0)">self</span><span style="color: rgb(98,98,98)">.</span>_sanitize_dataset(X)
<span class="ansi-green-fg">    339</span> coverage_matrix: np<span style="color: rgb(98,98,98)">.</span>ndarray <span style="color: rgb(98,98,98)">=</span> <span style="color: rgb(0,135,0)">self</span><span style="color: rgb(98,98,98)">.</span>calculate_coverage_matrix(X)
<span class="ansi-green-intense-fg ansi-bold">--&gt; 340</span> <span class="ansi-yellow-bg" style="color: rgb(0,135,0)">self</span><span class="ansi-yellow-bg" style="color: rgb(98,98,98)">.</span><span class="ansi-yellow-bg">_validate_object_state_before_prediction</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg">    341</span> <span class="ansi-bold" style="color: rgb(0,135,0)">return</span> <span style="color: rgb(0,135,0)">self</span><span style="color: rgb(98,98,98)">.</span>predict_using_coverage_matrix(coverage_matrix)

File <span class="ansi-green-intense-fg ansi-bold">c:\Users\cezar\OneDrive\Pulpit\EMAG\GIT\decision-rules\cn2\..\decision_rules\core\ruleset.py:55</span>, in <span class="ansi-cyan-fg">AbstractRuleSet._validate_object_state_before_prediction</span><span class="ansi-blue-intense-fg ansi-bold">(self)</span>
<span class="ansi-green-fg">     51</span> voting_weights_calculated: <span style="color: rgb(0,135,0)">bool</span> <span style="color: rgb(98,98,98)">=</span> <span style="color: rgb(0,135,0)">all</span>(
<span class="ansi-green-fg">     52</span>     [rule<span style="color: rgb(98,98,98)">.</span>coverage <span class="ansi-bold" style="color: rgb(175,0,255)">is</span> <span class="ansi-bold" style="color: rgb(175,0,255)">not</span> <span class="ansi-bold" style="color: rgb(0,135,0)">None</span> <span class="ansi-bold" style="color: rgb(0,135,0)">for</span> rule <span class="ansi-bold" style="color: rgb(175,0,255)">in</span> <span style="color: rgb(0,135,0)">self</span><span style="color: rgb(98,98,98)">.</span>rules]
<span class="ansi-green-fg">     53</span> )
<span class="ansi-green-fg">     54</span> <span class="ansi-bold" style="color: rgb(0,135,0)">if</span> <span class="ansi-bold" style="color: rgb(175,0,255)">not</span> voting_weights_calculated:
<span class="ansi-green-intense-fg ansi-bold">---&gt; 55</span>     <span class="ansi-bold" style="color: rgb(0,135,0)">raise</span> InvalidStateError(
<span class="ansi-green-fg">     56</span>         <span style="color: rgb(175,0,0)">&#34;</span><span style="color: rgb(175,0,0)">Rule coverages have to be calculated before performing prediction.</span><span style="color: rgb(175,0,0)">&#34;</span>
<span class="ansi-green-fg">     57</span>         <span style="color: rgb(98,98,98)">+</span> <span style="color: rgb(175,0,0)">&#34;</span><span style="color: rgb(175,0,0)">Did you forget to call update(...) method?</span><span style="color: rgb(175,0,0)">&#34;</span>
<span class="ansi-green-fg">     58</span>     )

<span class="ansi-red-intense-fg ansi-bold">InvalidStateError</span>: Rule coverages have to be calculated before performing prediction.Did you forget to call update(...) method?
</pre></div></div>
</div>
<p>As the error message indicates, we forgot to call the update(…) method on the ruleset object. This method requires a dataset and a quality measure to calculate the quality of the rules used later to resolve conflicts during prediction.</p>
<p>The Orange CN2 algorithm uses a confidence quality measure to resolve conflicts during prediction. Decision rules do not provide such a measure, but it is very easy to write your own implementation. Below we can see the equation for calculating confidence based on the confusion matrix.</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Confidence = (TP + TN) / (TP + TN + FP + FN)
</pre></div>
</div>
<p>However, in decision rules, quality is measured by a function taking a single parameter of type <code class="docutils literal notranslate"><span class="pre">decision_rules.core.coverage.Coverage</span></code>. Coverage objects contain information about examples covered by the rule, and contain four fields: p, n, P and N. p is the number of positive examples predicted as positive. positive examples predicted as positive, n is the number of negative examples predicted as positive. As positive. P and N are the total number of positive and negative examples in the
entire dataset. As we can see, the <code class="docutils literal notranslate"><span class="pre">Coverage</span></code> objects are simply another representation of the confusion matrix. Knowing this, we can simply write our trust quality measurement function as follows:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">decision_rules.core.coverage</span> <span class="kn">import</span> <span class="n">Coverage</span>

<span class="k">def</span> <span class="nf">confidence</span><span class="p">(</span><span class="n">c</span><span class="p">:</span> <span class="n">Coverage</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">P</span> <span class="o">+</span> <span class="n">c</span><span class="o">.</span><span class="n">N</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">P</span> <span class="o">+</span> <span class="n">c</span><span class="o">.</span><span class="n">N</span> <span class="o">+</span> <span class="n">c</span><span class="o">.</span><span class="n">n</span> <span class="o">+</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Now we can use our quality function with the <code class="docutils literal notranslate"><span class="pre">update(...)</span></code> method of the rule set to calculate the the quality of the rules.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_</span> <span class="o">=</span> <span class="n">ruleset</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">measure</span><span class="o">=</span><span class="k">lambda</span> <span class="n">c</span><span class="p">:</span> <span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">P</span> <span class="o">+</span> <span class="n">c</span><span class="o">.</span><span class="n">N</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">P</span> <span class="o">+</span> <span class="n">c</span><span class="o">.</span><span class="n">N</span> <span class="o">+</span> <span class="n">c</span><span class="o">.</span><span class="n">n</span> <span class="o">+</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span><span class="p">))</span>
</pre></div>
</div>
</div>
<p>Now let’s check again that both models predicts the same.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ruleset_pred</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">ruleset</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

<span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">cn2_pred</span><span class="p">,</span> <span class="n">ruleset_pred</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
False
</pre></div></div>
</div>
<p>There is still a difference in the predictions. It is because both models are using different conflict resolution strategies. Decision-rules models use voting strategy by default. It means that when more than one rules from different classes covers the same example, they “vote” for their class. Each vote of the specific rule is multiplied by its quality (voting_weight). Finally, the class with the highest score is selected. However, this is not the way conflicts are resolved in the CN2
algorithm. Instead of conducting a vote, it selects the first rule from a set of rules that that covers the given examples and uses it to get the predicted value.</p>
<p>Decision-rules package provides us with two prediction strategies: <code class="docutils literal notranslate"><span class="pre">vote</span></code> and <code class="docutils literal notranslate"><span class="pre">best_rule</span></code>. The first one we’ve already discussed. The second one select the rule with the highest quality from all the rules covering given examples and use it to predict for this example. Unfortunately, none of these already existing strategies fit our case. In this example, we will demonstrate how easily we can write our own custom prediction strategy that does exactly the same thing as our original algorithm.</p>
<p>To implement our own prediction strategy we need to write a class inheriting from <code class="docutils literal notranslate"><span class="pre">decision_rules.core.prediction.PredictionStrategy</span></code> class. It have to implement a single method <code class="docutils literal notranslate"><span class="pre">_perform_prediction</span></code> (and optionally overwrite others). This method takes a single parameter called <code class="docutils literal notranslate"><span class="pre">voting_matrix</span></code>. This is a numpy array containing as many rows as the predicted dataset and as many columns as the as many columns as the number of rules in our ruleset. For each row (example) and column (rule), it
stores zero (if the rule does not include the example) or the quality of the rule (if the rule includes the example). Such an array is very convenient for implementation of various prediction strategies. Below we can see the finished implementation.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">decision_rules.core.prediction</span> <span class="kn">import</span> <span class="n">PredictionStrategy</span>


<span class="k">class</span> <span class="nc">FirstRuleCoveringStrategy</span><span class="p">(</span><span class="n">PredictionStrategy</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">_perform_prediction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">voting_matrix</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="n">predictions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rules</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">conclusion</span><span class="o">.</span><span class="n">value</span>
                <span class="c1"># numpy argmax will return first occurence of the maximum</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">voting_matrix</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="c1"># we need to handle examples uncovered by any rule using default rule/conclusion</span>
        <span class="n">predictions</span><span class="p">[</span><span class="n">voting_matrix</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_conclusion</span><span class="o">.</span><span class="n">value</span>
        <span class="k">return</span> <span class="n">predictions</span>
</pre></div>
</div>
</div>
<p>Now we configure our rule set to use our custom prediction strategy. Then we check again if the predictions are the same for both models.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ruleset</span><span class="o">.</span><span class="n">set_prediction_strategy</span><span class="p">(</span><span class="n">FirstRuleCoveringStrategy</span><span class="p">)</span>

<span class="c1"># original model predicitons (we need to transform class probabilities to class labels)</span>
<span class="n">cn2_pred</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">cn2_clasifier</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">titanic</span><span class="o">.</span><span class="n">X</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="c1"># decision-rules ruleset predictions</span>
<span class="n">ruleset_pred</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">ruleset</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

<span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">cn2_pred</span><span class="p">,</span> <span class="n">ruleset_pred</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
True
</pre></div></div>
</div>
<p>Finally we achieved the same predictions.</p>
<p>This example showed us how the decision rule package can be used with different rule induction algorithms. Rule induction algorithm. Even if it does not implement all possible prediction mechanisms we can easily extend it to fit many different cases.</p>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="generating_with_rulekit.html" class="btn btn-neutral float-left" title="Generating rules with RuleKit" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../illustrative_example.html" class="btn btn-neutral float-right" title="Illustrative examples" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Cezary Maszczyk, Dawid Macha, Adam Grzelak.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>